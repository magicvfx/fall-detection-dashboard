<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>üö® Fall & SOS Alerts</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; padding:20px; }
    h1 { text-align:center; }
    .alert {
      background:#fff;
      padding:12px;
      margin:15px 0;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .type { font-weight:bold; font-size:18px; }
    .fall { color: red; }
    .sos { color: orange; }
    .map {
      width:100%;
      height:250px;
      margin-top:10px;
      border-radius:6px;
      overflow:hidden;
    }
  </style>
</head>
<body>
  <h1>üö® Fall Detection & SOS Alerts</h1>
  <div id="alerts"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCoSb7TW3Wgz5zzWVajpk2l8DqFKYEK-3o",
      authDomain: "fall-dectation.firebaseapp.com",
      databaseURL: "https://fall-dectation-default-rtdb.firebaseio.com",
      projectId: "fall-dectation",
      storageBucket: "fall-dectation.firebasestorage.app",
      messagingSenderId: "467192692594",
      appId: "1:467192692594:web:2756ad46d7d1fbb210e7eb"
    };
    firebase.initializeApp(firebaseConfig);

    const alertsRef = firebase.database().ref("alerts");
    const messaging = firebase.messaging();

    // Request notification permission
    if (Notification.permission !== "granted") {
      Notification.requestPermission().then(permission => {
        console.log("Notification permission:", permission);
      });
    }

    // Listen for new alerts
    alertsRef.on("child_added", snap => {
      const data = snap.val();
      displayAlert(data);
      triggerNotification(data);
    });

    // Display alert on dashboard
    function displayAlert(data) {
      const container = document.createElement("div");
      container.className = "alert";

      // Color by type
      let typeClass = data.type.toLowerCase() === "sos" ? "sos" : "fall";

      const mapFrame = `
        <div class="map">
          <iframe 
            width="100%" height="100%" frameborder="0" style="border:0"
            src="https://www.google.com/maps?q=${data.lat},${data.lng}&z=16&output=embed"
            allowfullscreen>
          </iframe>
        </div>
      `;

      container.innerHTML = `
        <div class="type ${typeClass}">‚ö° ${data.type}</div>
        <div>üìç Lat: ${data.lat}, Lng: ${data.lng}</div>
        <div>üîã Battery: ${parseFloat(data.battery).toFixed(2)} V</div>
        <div>üïí ${data.time || "No time available"}</div>
        ${mapFrame}
      `;
      
      document.getElementById("alerts").prepend(container);
    }

    // Trigger browser notification
    function triggerNotification(data) {
      if (Notification.permission === "granted") {
        let iconUrl = data.type.toLowerCase() === "sos" 
                      ? "https://cdn-icons-png.flaticon.com/512/564/564619.png"
                      : "https://cdn-icons-png.flaticon.com/512/565/565547.png";

        new Notification(`${data.type} Alert!`, {
          body: `Lat: ${data.lat}, Lng: ${data.lng}\nBattery: ${parseFloat(data.battery).toFixed(2)} V`,
          icon: iconUrl
        });
      }
    }

    // FCM token for background notifications
    messaging.getToken({ 
      vapidKey: "BP4bj_O1elFfLdvMRkaSTdAkdMu0I3K90WincKaNW-N6WSYIC5gWIUdWHKH_Tn1ER4UMbiaitgiI_6RxGOPmj4k" 
    }).then(token => {
      if(token) console.log("FCM Token:", token);
    }).catch(err => console.error("FCM token error:", err));

    // Handle foreground messages
    messaging.onMessage(payload => {
      console.log("Foreground message received:", payload);
      new Notification(payload.notification.title, {
        body: payload.notification.body,
        icon: "https://cdn-icons-png.flaticon.com/512/564/564619.png"
      });
    });
  </script>
</body>
</html>
